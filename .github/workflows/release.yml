name: Release and Auto-Update

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ìŠ¤ ë²„ì „ (ì˜ˆ: v1.0.1)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: windows-latest
    
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NODE_OPTIONS: --max_old_space_size=4096
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Get version from tag or input
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "ë¦´ë¦¬ìŠ¤ ë²„ì „: $version"
        shell: powershell
        
      - name: Install dependencies
        run: npm ci
        
      - name: Type check
        run: npm run type-check
        
      - name: Lint check
        run: npm run lint
        
      - name: Run tests
        run: npm test -- --watchAll=false
        
      - name: Build application
        run: npm run build
        
      - name: Build and publish Electron app
        run: npm run dist:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-${{ steps.version.outputs.VERSION }}
          path: |
            release/*.exe
            release/*.yml
            release/*.blockmap
            release/latest.yml
          retention-days: 30
          
      - name: Create release notes
        id: release_notes
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $notes = @"
          ## CVM í‚¤ì˜¤ìŠ¤í¬ $version ë¦´ë¦¬ìŠ¤
          
          ### ğŸ“¦ ì„¤ì¹˜ íŒŒì¼
          - **CVM-Kiosk-$version-Setup.exe**: ìë™ ì„¤ì¹˜ í”„ë¡œê·¸ë¨
          - **latest.yml**: ìë™ ì—…ë°ì´íŠ¸ ë©”íƒ€ë°ì´í„°
          
          ### ğŸ”„ ìë™ ì—…ë°ì´íŠ¸
          - ê¸°ì¡´ í‚¤ì˜¤ìŠ¤í¬ ê¸°ê¸°ëŠ” ìë™ìœ¼ë¡œ ì´ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤
          - ì—…ë°ì´íŠ¸ëŠ” ì‹¬ì•¼ ì‹œê°„(ì˜¤ì „ 2-5ì‹œ)ì— ìë™ ì„¤ì¹˜ë©ë‹ˆë‹¤
          - ê°•ì œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸: í™˜ê²½ë³€ìˆ˜ ``CVM_INSTALL_NOW=1`` ì„¤ì •
          
          ### ğŸ“‹ ë³€ê²½ì‚¬í•­
          - ìƒˆë¡œìš´ ê¸°ëŠ¥ ë° ê°œì„ ì‚¬í•­ë“¤ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤
          - ë³´ì•ˆ ì—…ë°ì´íŠ¸ ë° ì„±ëŠ¥ ìµœì í™”
          - ë²„ê·¸ ìˆ˜ì • ë° ì•ˆì •ì„± í–¥ìƒ
          
          ### ğŸ› ï¸ ìˆ˜ë™ ì„¤ì¹˜ ë°©ë²•
          1. **CVM-Kiosk-$version-Setup.exe** ë‹¤ìš´ë¡œë“œ
          2. ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
          3. ì„¤ì¹˜ ì™„ë£Œ í›„ ìë™ ì‹œì‘
          
          ### ğŸ“ ì§€ì›
          ë¬¸ì œ ë°œìƒ ì‹œ [Issues](https://github.com/jimeKim/CVM-Kiosk-App/issues)ì— ì‹ ê³ í•´ì£¼ì„¸ìš”.
          "@
          $notes | Out-File -FilePath release_notes.md -Encoding UTF8
          echo "RELEASE_NOTES_FILE=release_notes.md" >> $env:GITHUB_OUTPUT
        shell: powershell
        
      - name: Check if release exists
        id: check_release
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          try {
            $release = gh release view $version --json id 2>$null
            if ($release) {
              echo "RELEASE_EXISTS=true" >> $env:GITHUB_OUTPUT
              echo "ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ë°œê²¬: $version"
            } else {
              echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
              echo "ìƒˆ ë¦´ë¦¬ìŠ¤ ìƒì„± í•„ìš”: $version"
            }
          } catch {
            echo "RELEASE_EXISTS=false" >> $env:GITHUB_OUTPUT
            echo "ìƒˆ ë¦´ë¦¬ìŠ¤ ìƒì„± í•„ìš”: $version"
          }
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create GitHub Release
        if: steps.check_release.outputs.RELEASE_EXISTS == 'false'
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          gh release create $version `
            --title "CVM í‚¤ì˜¤ìŠ¤í¬ $version" `
            --notes-file ${{ steps.release_notes.outputs.RELEASE_NOTES_FILE }} `
            --latest `
            release/*.exe `
            release/*.yml `
            release/*.blockmap
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update existing release
        if: steps.check_release.outputs.RELEASE_EXISTS == 'true'
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          echo "ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ ì—…ë°ì´íŠ¸: $version"
          
          # ê¸°ì¡´ ì—ì…‹ ì œê±° í›„ ìƒˆ ì—ì…‹ ì—…ë¡œë“œ
          gh release upload $version release/*.exe release/*.yml release/*.blockmap --clobber
          
          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ì—…ë°ì´íŠ¸
          gh release edit $version --notes-file ${{ steps.release_notes.outputs.RELEASE_NOTES_FILE }}
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify deployment success
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          echo "âœ… ë¦´ë¦¬ìŠ¤ $version ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“¦ í‚¤ì˜¤ìŠ¤í¬ ê¸°ê¸°ë“¤ì´ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤."
          echo "ğŸ•’ ì„¤ì¹˜ëŠ” ì‹¬ì•¼ ì‹œê°„(ì˜¤ì „ 2-5ì‹œ)ì— ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤."
        shell: powershell

  # ì„ íƒì : ë‹¤ë¥¸ í”Œë«í¼ ë¹Œë“œ (í•„ìš” ì‹œ í™œì„±í™”)
  build-other-platforms:
    if: false # í˜„ì¬ëŠ” ë¹„í™œì„±í™”, í•„ìš” ì‹œ trueë¡œ ë³€ê²½
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build for ${{ matrix.os }}
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            npm run build:linux
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            npm run build:mac
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
