<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª ë§¤íŠ¸ë¦­ìŠ¤ ì œì–´ë³´ë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #00ff00;
            padding: 20px;
            border-radius: 10px;
        }
        .section {
            margin: 20px 0;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .matrix-btn {
            padding: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .matrix-btn:hover {
            background: #555;
        }
        .matrix-btn.active {
            background: #ff0000;
            border-color: #ff4444;
        }
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .control-btn {
            padding: 12px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .control-btn:hover {
            background: #0088ff;
        }
        .control-btn.danger {
            background: #cc0000;
        }
        .control-btn.danger:hover {
            background: #ff0000;
        }
        .control-btn.success {
            background: #00cc00;
        }
        .control-btn.success:hover {
            background: #00ff00;
        }
        .log-area {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .status-bar {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-connected {
            color: #00ff00;
        }
        .status-disconnected {
            color: #ff0000;
        }
        .test-pattern {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .binary-display {
            font-family: monospace;
            background: #000;
            color: #ffff00;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ë§¤íŠ¸ë¦­ìŠ¤ ì œì–´ë³´ë“œ ì•„ë‘ì´ë…¸ í…ŒìŠ¤íŠ¸</h1>
            <p>PC â†’ ì•„ë‘ì´ë…¸ â†’ ì œì–´ë³´ë“œ í†µì‹  í…ŒìŠ¤íŠ¸</p>
            <p style="color: #ffff00;">âš ï¸ ì•„ë‘ì´ë…¸ì— arduino-matrix-test.ino ì—…ë¡œë“œ í•„ìš”</p>
        </div>

        <div class="section">
            <h3>ğŸ“¡ ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²°</h3>
            <div class="status-bar">
                <span>ì—°ê²° ìƒíƒœ: <span id="connectionStatus" class="status-disconnected">ì—°ê²° ì•ˆë¨</span></span>
                <span>í¬íŠ¸: <span id="currentPort">ì—†ìŒ</span></span>
                <span>Baud Rate: <span id="currentBaud">115200</span></span>
            </div>
            <div class="control-panel">
                <button class="control-btn success" onclick="connectSerial()">ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²°</button>
                <button class="control-btn danger" onclick="disconnectSerial()">ì—°ê²° í•´ì œ</button>
                <select id="baudRateSelect" onchange="updateBaudRate()">
                    <option value="9600">9600</option>
                    <option value="115200" selected>115200</option>
                </select>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ¯ 5x8 ë§¤íŠ¸ë¦­ìŠ¤ ë²„íŠ¼ í…ŒìŠ¤íŠ¸</h3>
            <div class="button-grid" id="matrixGrid">
                <!-- 40ê°œ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì  ìƒì„±ë¨ -->
            </div>
            <div class="control-panel">
                <button class="control-btn" onclick="testSingleButton()">ë‹¨ì¼ ë²„íŠ¼ í…ŒìŠ¤íŠ¸</button>
                <button class="control-btn" onclick="testSequential()">ìˆœì°¨ í…ŒìŠ¤íŠ¸</button>
                <button class="control-btn" onclick="testPattern()">íŒ¨í„´ í…ŒìŠ¤íŠ¸</button>
                <button class="control-btn danger" onclick="clearAll()">ì „ì²´ ë„ê¸°</button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ”¬ ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ ì „ì†¡</h3>
            <div class="test-pattern">
                <input type="number" id="testRow" placeholder="í–‰ (1-5)" min="1" max="5" value="1">
                <input type="number" id="testCol" placeholder="ì—´ (1-8)" min="1" max="8" value="1">
                <select id="testOnOff">
                    <option value="1">ON</option>
                    <option value="0">OFF</option>
                </select>
                <button class="control-btn" onclick="sendArduinoTestCommand()">ëª…ë ¹ì–´ ì „ì†¡</button>
            </div>
            <div class="test-pattern">
                <input type="text" id="customCommand" placeholder="ì§ì ‘ ëª…ë ¹ì–´ ì…ë ¥ (ì˜ˆ: B1, T111, STATUS)" style="flex: 1; padding: 8px;">
                <button class="control-btn" onclick="sendCustomCommand()">ì „ì†¡</button>
            </div>
            <div class="binary-display" id="binaryDisplay">
                ì „ì†¡ ëª…ë ¹ì–´: ì—†ìŒ
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div class="control-panel">
                <button class="control-btn" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                <button class="control-btn" onclick="downloadLog()">ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="log-area" id="logArea">
                === ë§¤íŠ¸ë¦­ìŠ¤ ì œì–´ë³´ë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===<br>
            </div>
        </div>
    </div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;
        let isConnected = false;

        // ë§¤íŠ¸ë¦­ìŠ¤ ë²„íŠ¼ ìƒì„±
        function createMatrixButtons() {
            const grid = document.getElementById('matrixGrid');
            for (let i = 1; i <= 40; i++) {
                const button = document.createElement('button');
                button.className = 'matrix-btn';
                button.textContent = i;
                button.onclick = () => clickMatrixButton(i);
                button.id = `btn-${i}`;
                grid.appendChild(button);
            }
        }

        // ë¡œê·¸ ì¶œë ¥
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#ffffff';
            logArea.innerHTML += `<span style="color: #666">[${timestamp}]</span> <span style="color: ${color}">${message}</span><br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²°
        async function connectSerial() {
            try {
                if ('serial' in navigator) {
                    port = await navigator.serial.requestPort();
                    const baudRate = parseInt(document.getElementById('baudRateSelect').value);
                    
                    await port.open({ baudRate });
                    
                    reader = port.readable.getReader();
                    writer = port.writable.getWriter();
                    
                    isConnected = true;
                    updateConnectionStatus(true);
                    log('ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° ì„±ê³µ!', 'success');
                    
                    // ë°ì´í„° ìˆ˜ì‹  ì‹œì‘
                    startReading();
                } else {
                    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Serial APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome 89+ ì‚¬ìš© í•„ìš”');
                }
            } catch (error) {
                log(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì—°ê²° í•´ì œ
        async function disconnectSerial() {
            try {
                if (reader) {
                    await reader.cancel();
                    reader = null;
                }
                if (writer) {
                    writer.releaseLock();
                    writer = null;
                }
                if (port) {
                    await port.close();
                    port = null;
                }
                isConnected = false;
                updateConnectionStatus(false);
                log('ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° í•´ì œ', 'info');
            } catch (error) {
                log(`ì—°ê²° í•´ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const portName = document.getElementById('currentPort');
            
            if (connected) {
                status.textContent = 'ì—°ê²°ë¨';
                status.className = 'status-connected';
                portName.textContent = 'COM11'; // ê°€ì •
            } else {
                status.textContent = 'ì—°ê²° ì•ˆë¨';
                status.className = 'status-disconnected';
                portName.textContent = 'ì—†ìŒ';
            }
        }

        // ë°ì´í„° ìˆ˜ì‹ 
        async function startReading() {
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    log(`ìˆ˜ì‹ : ${text.trim()}`, 'success');
                }
            } catch (error) {
                log(`ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ ì „ì†¡
        async function sendArduinoCommand(command) {
            if (!isConnected || !writer) {
                log('ì‹œë¦¬ì–¼ í¬íŠ¸ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return false;
            }

            try {
                const commandData = new TextEncoder().encode(command + '\n');
                await writer.write(commandData);
                
                document.getElementById('binaryDisplay').textContent = `ì „ì†¡ ëª…ë ¹ì–´: ${command}`;
                log(`ì•„ë‘ì´ë…¸ ëª…ë ¹ ì „ì†¡: ${command}`, 'info');
                return true;
            } catch (error) {
                log(`ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
                return false;
            }
        }

        // ë§¤íŠ¸ë¦­ìŠ¤ ëª…ë ¹ ì „ì†¡ (ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ ë°©ì‹)
        async function sendMatrixCommand(row, col, on) {
            const command = `T${row}${col}${on}`;
            const success = await sendArduinoCommand(command);
            if (success) {
                log(`ë§¤íŠ¸ë¦­ìŠ¤ ëª…ë ¹: [${row},${col}] ${on ? 'ON' : 'OFF'}`, 'info');
            }
            return success;
        }

        // ë§¤íŠ¸ë¦­ìŠ¤ ë²„íŠ¼ í´ë¦­ (ì•„ë‘ì´ë…¸ ë²„íŠ¼ ëª…ë ¹ì–´ ë°©ì‹)
        async function clickMatrixButton(buttonId) {
            const command = `B${buttonId}`;
            const success = await sendArduinoCommand(command);
            
            if (success) {
                // ì•„ë‘ì´ë…¸ê°€ í•­ìƒ ONìœ¼ë¡œ ë³´ë‚´ë¯€ë¡œ UIì—ì„œ í† ê¸€ ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜
                const button = document.getElementById(`btn-${buttonId}`);
                const isActive = button.classList.contains('active');
                
                if (!isActive) {
                    button.classList.add('active');
                    log(`ë²„íŠ¼ ${buttonId} â†’ ON`, 'success');
                } else {
                    button.classList.remove('active');
                    log(`ë²„íŠ¼ ${buttonId} â†’ OFF (UI í† ê¸€)`, 'success');
                }
            }
        }

        // ì§ì ‘ ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ ì „ì†¡
        async function sendArduinoTestCommand() {
            const row = parseInt(document.getElementById('testRow').value);
            const col = parseInt(document.getElementById('testCol').value);
            const on = parseInt(document.getElementById('testOnOff').value);

            if (row < 1 || row > 5 || col < 1 || col > 8) {
                log('ì˜ëª»ëœ ì¢Œí‘œì…ë‹ˆë‹¤. í–‰(1-5), ì—´(1-8)', 'error');
                return;
            }

            await sendMatrixCommand(row, col, on);
        }

        // ì‚¬ìš©ì ì •ì˜ ëª…ë ¹ì–´ ì „ì†¡
        async function sendCustomCommand() {
            const command = document.getElementById('customCommand').value.trim();
            if (command) {
                await sendArduinoCommand(command);
            } else {
                log('ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            }
        }

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ (ì•„ë‘ì´ë…¸ ëª…ë ¹ì–´ ë°©ì‹)
        async function testSingleButton() {
            log('=== ë‹¨ì¼ ë²„íŠ¼ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            await sendArduinoCommand('STATUS');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            for (let i = 0; i < 3; i++) {
                await sendArduinoCommand('B1');  // ë²„íŠ¼ 1 í´ë¦­
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            log('=== ë‹¨ì¼ ë²„íŠ¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'info');
        }

        async function testSequential() {
            log('=== ìˆœì°¨ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            await sendArduinoCommand('STATUS');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            for (let i = 1; i <= 40; i++) {
                await sendArduinoCommand(`B${i}`);
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await sendArduinoCommand('CLEAR');
            log('=== ìˆœì°¨ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'info');
        }

        async function testPattern() {
            log('=== íŒ¨í„´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===', 'info');
            // ì²´ìŠ¤íŒ íŒ¨í„´
            for (let r = 1; r <= 5; r++) {
                for (let c = 1; c <= 8; c++) {
                    const on = (r + c) % 2;
                    await sendMatrixCommand(r, c, on);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            await new Promise(resolve => setTimeout(resolve, 2000));
            await clearAll();
            log('=== íŒ¨í„´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'info');
        }

        async function clearAll() {
            log('=== ì „ì²´ ë„ê¸° ì‹œì‘ ===', 'info');
            await sendArduinoCommand('CLEAR');
            
            // UI ì—…ë°ì´íŠ¸
            for (let i = 1; i <= 40; i++) {
                document.getElementById(`btn-${i}`).classList.remove('active');
            }
            log('=== ì „ì²´ ë„ê¸° ì™„ë£Œ ===', 'success');
        }

        // Baud Rate ë³€ê²½
        function updateBaudRate() {
            const baudRate = document.getElementById('baudRateSelect').value;
            document.getElementById('currentBaud').textContent = baudRate;
            if (isConnected) {
                log(`Baud Rate ë³€ê²½ë¨: ${baudRate} (ì¬ì—°ê²° í•„ìš”)`, 'info');
            }
        }

        // ë¡œê·¸ ê´€ë¦¬
        function clearLog() {
            document.getElementById('logArea').innerHTML = '=== ë¡œê·¸ ì§€ì›Œì§ ===<br>';
        }

        function downloadLog() {
            const logContent = document.getElementById('logArea').innerHTML
                .replace(/<br>/g, '\n')
                .replace(/<[^>]*>/g, '');
            
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `matrix-test-log-${new Date().getTime()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = function() {
            createMatrixButtons();
            log('ì•„ë‘ì´ë…¸ ë§¤íŠ¸ë¦­ìŠ¤ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ!', 'success');
            log('ì‚¬ì „ ì¤€ë¹„:', 'info');
            log('1. ì•„ë‘ì´ë…¸ì— arduino-matrix-test.ino ì—…ë¡œë“œ', 'info');
            log('2. ì•„ë‘ì´ë…¸-ì œì–´ë³´ë“œ ì—°ê²° í™•ì¸', 'info');
            log('3. ì œì–´ë³´ë“œ ì „ì› í™•ì¸', 'info');
            log('í…ŒìŠ¤íŠ¸ ë°©ë²•:', 'info');
            log('1. ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²° ë²„íŠ¼ í´ë¦­', 'info');
            log('2. COM11 í¬íŠ¸ ì„ íƒ', 'info');
            log('3. STATUS ëª…ë ¹ì–´ë¡œ ì•„ë‘ì´ë…¸ ìƒíƒœ í™•ì¸', 'info');
            log('4. ë§¤íŠ¸ë¦­ìŠ¤ ë²„íŠ¼ í´ë¦­í•˜ì—¬ ëª¨í„° ì‘ë™ í…ŒìŠ¤íŠ¸', 'info');
        };
    </script>
</body>
</html>